<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Valkyrie T3 Stock ç®¡ç†ç³»çµ±</title>
    <style>
        :root { --primary-color: #2ecc71; --secondary-color: #d35400; --dark-blue: #34495e; --edit-color: #9b59b6; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 1250px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .header { text-align: center; margin-bottom: 20px; }
        .header img { max-width: 120px; margin-bottom: 10px; }
        h2 { font-family: "Cooper Black", serif; color: var(--primary-color); font-size: 3em; margin: 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .alert-info { background-color: #e8f8f0; border-left: 5px solid var(--primary-color); padding: 15px; margin: 20px 0; border-radius: 4px; font-size: 0.95em; }
        .action-bar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px; }
        button { cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-withdraw { background-color: var(--secondary-color); color: white; padding: 12px 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-add { background-color: #3498db; color: white; padding: 12px 24px; }
        .btn-edit { background-color: var(--edit-color); color: white; padding: 5px 10px; font-size: 12px; }
        .btn-delete { background-color: #bdc3c7; color: white; padding: 5px 10px; font-size: 12px; }
        .btn-save { background-color: var(--primary-color); color: white; padding: 12px; width: 100%; font-size: 1.1em; margin-top: 15px; justify-content: center; }
        table { width: 100%; border-collapse: collapse; background: white; overflow: hidden; table-layout: fixed; }
        th { background-color: var(--dark-blue); color: white; padding: 15px; font-weight: 500; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; word-wrap: break-word; }
        .readonly-note { background-color: #f9f9f9; border: 1px solid #eee; color: #7f8c8d; font-size: 12px; text-align: left; padding: 5px; border-radius: 4px; white-space: pre-wrap; max-height: 80px; overflow-y: auto; }
        .qty-box { font-size: 1.1em; font-weight: bold; }
        .ops-cell { display: flex; gap: 5px; justify-content: center; }
        select, input, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 14px; }
        .other-input { display: none; margin-top: 8px; border: 1px solid var(--primary-color); background: #f0fff4; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { background: white; margin: 2% auto; padding: 25px; border-radius: 12px; width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--dark-blue); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="snake.png" alt="Logo">
        <h2>Valkyrie T3 Stock</h2>
    </div>
    <div class="alert-info">ğŸ“¢ é ˜ç”¨èªªæ˜ï¼šé ˜å–å‰è«‹å…ˆå‘å°ˆæ¡ˆ PM ç¢ºèªï¼›æ ¸å‡†å¾Œæ›´æ–°ç´€éŒ„ã€‚</div>
    <div class="action-bar">
        <button class="btn-withdraw" onclick="toggleModal('withdrawModal', true)">ğŸ“‹ é ˜ç”¨ç™»è¨˜</button>
        <button class="btn-add" onclick="openAddModal()">ï¼‹ æ–°å¢åº«å­˜</button>
    </div>
    <table id="inventoryTable">
        <thead>
            <tr>
                <th width="12%">ç”¢å“é¡åˆ¥</th><th width="10%">é¡è‰²</th><th width="10%">é¡å‹</th><th width="10%">ç”¢åœ°</th><th width="10%">Phase</th><th width="14%">åº«å­˜ (ç¸½|å‰©)</th><th width="24%">å‚™è¨»</th><th width="10%">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="inventoryBody"></tbody>
    </table>
</div>

<div id="itemModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">âœ¨ æ–°å¢åº«å­˜å“é …</h3>
        <input type="hidden" id="edit_index">
        
        <div style="margin-bottom:15px">
            <label>ç”¢å“é¡åˆ¥</label>
            <select id="i_cat" onchange="toggleOtherInput(this, 'i_cat_other')">
                <option value="è€³æ©Ÿ">è€³æ©Ÿ</option><option value="ç·šæ">ç·šæ</option><option value="Mic Boom">Mic Boom</option><option value="å…¶ä»–">å…¶ä»–...</option>
            </select>
            <input type="text" id="i_cat_other" class="other-input" placeholder="è«‹è¼¸å…¥é¡åˆ¥">
        </div>

        <div style="margin-bottom:15px">
            <label>é¡è‰²</label>
            <select id="i_color" onchange="toggleOtherInput(this, 'i_color_other')">
                <option value="Black">Black</option><option value="White">White</option><option value="N/A">N/A</option><option value="å…¶ä»–">å…¶ä»–...</option>
            </select>
            <input type="text" id="i_color_other" class="other-input" placeholder="è«‹è¼¸å…¥é¡è‰²">
        </div>

        <div style="margin-bottom:15px">
            <label>é¡å‹</label>
            <select id="i_type" onchange="toggleOtherInput(this, 'i_type_other')">
                <option value="PC">PC</option><option value="PS">PS</option><option value="XBOX">XBOX</option><option value="N/A">N/A</option><option value="å…¶ä»–">å…¶ä»–...</option>
            </select>
            <input type="text" id="i_type_other" class="other-input" placeholder="è«‹è¼¸å…¥é¡å‹">
        </div>

        <div style="margin-bottom:15px">
            <label>ç”¢åœ°</label>
            <select id="i_origin" onchange="toggleOtherInput(this, 'i_origin_other')">
                <option value="China">China</option><option value="Vietnam">Vietnam</option><option value="Thailand">Thailand</option><option value="å…¶ä»–">å…¶ä»–...</option>
            </select>
            <input type="text" id="i_origin_other" class="other-input" placeholder="è«‹è¼¸å…¥ç”¢åœ°">
        </div>

        <div style="margin-bottom:15px"><label>Phase</label><input type="text" id="i_phase"></div>
        <div style="margin-bottom:15px"><label>ç¸½åº«å­˜æ•¸é‡</label><input type="number" id="i_qty" value="1"></div>
        <div style="margin-bottom:15px"><label>å‚™è¨»</label><textarea id="i_note" rows="3"></textarea></div>
        
        <button class="btn-save" onclick="saveItem()">å„²å­˜ä¸¦æ›´æ–°é›²ç«¯</button>
        <button style="background:none; width:100%; margin-top:10px; color:#7f8c8d" onclick="toggleModal('itemModal', false)">å–æ¶ˆè¿”å›</button>
    </div>
</div>

<div id="withdrawModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ“¦ é ˜ç”¨ç™»è¨˜</h3>
        <div style="margin-bottom:15px"><label>é¸æ“‡å“é …</label><select id="m_target" onchange="syncWithdrawDetails()"></select></div>
        <div id="m_detail_box" style="display:none; background:#f9f9f9; padding:10px; border-radius:5px; margin-bottom:15px; border-left:4px solid var(--secondary-color);">
            ç›®å‰å‰©é¤˜åº«å­˜: <b id="d_remain" style="color:red">0</b>
        </div>
        <div style="margin-bottom:15px"><label>é ˜ç”¨æ•¸é‡</label><input type="number" id="m_qty" value="1"></div>
        <div style="margin-bottom:15px"><label>é ˜ç”¨åŸå› /é ˜ç”¨äºº</label><textarea id="m_note" placeholder="ä¾‹å¦‚ï¼šPM Andy æ¸¬è©¦ä½¿ç”¨"></textarea></div>
        <button class="btn-save" style="background:var(--secondary-color)" onclick="processWithdraw()">ç¢ºèªæ‰£é™¤åº«å­˜</button>
        <button style="background:none; width:100%; margin-top:10px; color:#7f8c8d" onclick="toggleModal('withdrawModal', false)">å–æ¶ˆ</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    const SUPABASE_URL = 'https://djjczmcajxjyqjkbjoud.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_kHc06K5jzjqPiAVj-eMGTg_1oOhA_6t';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let stockData = [];

    // åˆå§‹åŒ–æŠ“å–
    async function fetchStockData() {
        const { data, error } = await client.from('messages').select('*').order('created_at', { ascending: true });
        if (error) { 
            console.error('æŠ“å–å¤±æ•—:', error); 
        } else {
            stockData = data.map(item => ({ db_id: item.id, ...JSON.parse(item.content) }));
            renderTable();
        }
    }

    // å³æ™‚åŒæ­¥
    client.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => {
        fetchStockData();
    }).subscribe();

    // å„²å­˜é‚è¼¯
    async function saveItem() {
        const idx = document.getElementById('edit_index').value;
        const qty = parseInt(document.getElementById('i_qty').value);
        
        const payload = {
            category: getVal('i_cat', 'i_cat_other'),
            color: getVal('i_color', 'i_color_other'),
            type: getVal('i_type', 'i_type_other'),
            origin: getVal('i_origin', 'i_origin_other'),
            phase: document.getElementById('i_phase').value || "N/A",
            qty: qty,
            remain: (idx === "-1" ? qty : Math.max(0, stockData[idx].remain + (qty - stockData[idx].qty))),
            note: document.getElementById('i_note').value
        };

        if(!payload.category || !payload.origin) { alert("è«‹è‡³å°‘å¡«å¯«é¡åˆ¥èˆ‡ç”¢åœ°ï¼"); return; }

        if (idx === "-1") {
            await client.from('messages').insert([{ content: JSON.stringify(payload) }]);
        } else {
            await client.from('messages').update({ content: JSON.stringify(payload) }).eq('id', stockData[idx].db_id);
        }
        toggleModal('itemModal', false);
    }

    // é ˜ç”¨é‚è¼¯
    async function processWithdraw() {
        const idx = document.getElementById("m_target").value;
        const q = parseInt(document.getElementById("m_qty").value);
        if(idx === "" || q > stockData[idx].remain) { alert("åº«å­˜ä¸è¶³ï¼"); return; }
        
        const item = {...stockData[idx]};
        const targetId = item.db_id;
        item.remain -= q;
        item.note += `\n>> ${new Date().toLocaleString()} | é ˜ç”¨ -${q} | åŸå› : ${document.getElementById("m_note").value}`;
        
        delete item.db_id;
        await client.from('messages').update({ content: JSON.stringify(item) }).eq('id', targetId);
        toggleModal('withdrawModal', false);
    }

    async function deleteRow(index) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤å“é …ï¼Ÿé€™å°‡ç§»é™¤æ‰€æœ‰äººçš„ç•«é¢ç´€éŒ„ã€‚")) {
            await client.from('messages').delete().eq('id', stockData[index].db_id);
        }
    }

    // UI æ§åˆ¶å·¥å…·
    function toggleModal(id, show) { 
        document.getElementById(id).style.display = show ? "block" : "none"; 
        if (id === 'withdrawModal' && show) renderWithdrawOptions();
    }

    function toggleOtherInput(s, i) { 
        document.getElementById(i).style.display = (s.value === "å…¶ä»–") ? "block" : "none"; 
    }

    function getVal(sId, oId) {
        const s = document.getElementById(sId);
        return s.value === "å…¶ä»–" ? document.getElementById(oId).value : s.value;
    }

    function setVal(sId, oId, val, defaults) {
        const s = document.getElementById(sId);
        const o = document.getElementById(oId);
        if (defaults.includes(val)) {
            s.value = val; o.style.display = 'none';
        } else {
            s.value = "å…¶ä»–"; o.value = val; o.style.display = 'block';
        }
    }

    function openAddModal() {
        document.getElementById('modalTitle').textContent = "âœ¨ æ–°å¢åº«å­˜å“é …";
        document.getElementById('edit_index').value = "-1";
        // é‡è¨­æ¬„ä½
        ["i_cat", "i_color", "i_type", "i_origin"].forEach(id => {
            document.getElementById(id).selectedIndex = 0;
            document.getElementById(id + "_other").style.display = 'none';
            document.getElementById(id + "_other").value = "";
        });
        document.getElementById('i_phase').value = "";
        document.getElementById('i_qty').value = 1;
        document.getElementById('i_note').value = "";
        toggleModal('itemModal', true);
    }

    function openEditModal(index) {
        const item = stockData[index];
        document.getElementById('modalTitle').textContent = "âœï¸ ç·¨è¼¯åº«å­˜å“é …";
        document.getElementById('edit_index').value = index;
        setVal('i_cat', 'i_cat_other', item.category, ["è€³æ©Ÿ", "ç·šæ", "Mic Boom"]);
        setVal('i_color', 'i_color_other', item.color, ["Black", "White", "N/A"]);
        setVal('i_type', 'i_type_other', item.type, ["PC", "PS", "XBOX", "N/A"]);
        setVal('i_origin', 'i_origin_other', item.origin, ["China", "Vietnam", "Thailand"]);
        document.getElementById('i_phase').value = item.phase;
        document.getElementById('i_qty').value = item.qty;
        document.getElementById('i_note').value = item.note;
        toggleModal('itemModal', true);
    }

    function renderTable() {
        const tbody = document.getElementById("inventoryBody");
        tbody.innerHTML = "";
        stockData.forEach((item, index) => {
            let row = document.createElement("tr");
            row.innerHTML = `
                <td>${item.category}</td><td>${item.color}</td><td>${item.type}</td><td>${item.origin}</td><td>${item.phase}</td>
                <td><div class="qty-box">${item.qty} | <b style="color:var(--secondary-color)">${item.remain}</b></div></td>
                <td><div class="readonly-note">${item.note || ''}</div></td>
                <td class="ops-cell">
                    <button class="btn-edit" onclick="openEditModal(${index})">ç·¨è¼¯</button>
                    <button class="btn-delete" onclick="deleteRow(${index})">åˆªé™¤</button>
                </td>`;
            tbody.appendChild(row);
        });
    }

    function renderWithdrawOptions() {
        const s = document.getElementById("m_target");
        s.innerHTML = '<option value="">-- è«‹é¸æ“‡é ˜ç”¨å“é … --</option>';
        stockData.forEach((item, i) => {
            s.innerHTML += `<option value="${i}">${item.category}-${item.color}-${item.phase}</option>`;
        });
    }

    function syncWithdrawDetails() {
        const idx = document.getElementById("m_target").value;
        if(idx !== "") {
            document.getElementById("d_remain").textContent = stockData[idx].remain;
            document.getElementById("m_detail_box").style.display = "block";
        } else {
            document.getElementById("m_detail_box").style.display = "none";
        }
    }

    fetchStockData();
</script>
</body>
</html>
