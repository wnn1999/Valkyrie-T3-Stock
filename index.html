<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Valkyrie T3 Stock ç®¡ç†ç³»çµ±</title>
    <style>
        :root { --primary-color: #2ecc71; --secondary-color: #d35400; --dark-blue: #34495e; --edit-color: #9b59b6; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 1250px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        
        .header { text-align: center; margin-bottom: 20px; }
        .header img { max-width: 120px; margin-bottom: 10px; }
        h2 { font-family: "Cooper Black", serif; color: var(--primary-color); font-size: 3em; margin: 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        
        .alert-info { background-color: #e8f8f0; border-left: 5px solid var(--primary-color); padding: 15px; margin: 20px 0; border-radius: 4px; font-size: 0.95em; }

        .action-bar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px; }
        button { cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        
        .btn-withdraw { background-color: var(--secondary-color); color: white; padding: 12px 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-withdraw:hover { background-color: #e67e22; transform: translateY(-2px); }
        
        .btn-add { background-color: #3498db; color: white; padding: 12px 24px; }
        .btn-edit { background-color: var(--edit-color); color: white; padding: 5px 10px; font-size: 12px; }
        .btn-delete { background-color: #bdc3c7; color: white; padding: 5px 10px; font-size: 12px; }
        .btn-save { background-color: var(--primary-color); color: white; padding: 12px; width: 100%; font-size: 1.1em; margin-top: 15px; justify-content: center; }

        table { width: 100%; border-collapse: collapse; background: white; overflow: hidden; table-layout: fixed; }
        th { background-color: var(--dark-blue); color: white; padding: 15px; font-weight: 500; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; word-wrap: break-word; }
        
        .readonly-note { 
            background-color: #f9f9f9; 
            border: 1px solid #eee; 
            color: #7f8c8d; 
            font-size: 12px; 
            text-align: left; 
            padding: 5px; 
            border-radius: 4px; 
            white-space: pre-wrap; 
            max-height: 80px; 
            overflow-y: auto; 
        }

        .qty-box { font-size: 1.1em; font-weight: bold; }
        .ops-cell { display: flex; gap: 5px; justify-content: center; }
        
        select, input, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 14px; }
        .other-input { display: none; margin-top: 8px; border: 1px solid var(--primary-color); background: #f0fff4; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { background: white; margin: 2% auto; padding: 25px; border-radius: 12px; width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal-header { border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; }
        .field-group { margin-bottom: 15px; }
        .field-group label { display: block; margin-bottom: 6px; font-weight: bold; font-size: 0.9em; color: #666; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px dashed var(--primary-color); }
        .info-item { font-size: 0.9em; color: #555; }
        .info-item b { color: #2c3e50; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="snake.png" alt="Logo">
        <h2>Valkyrie T3 Stock</h2>
    </div>

    <div class="alert-info">ğŸ“¢ é ˜ç”¨èªªæ˜ï¼šé ˜å–å‰è«‹å…ˆå‘å°ˆæ¡ˆ PM ç¢ºèªï¼›æ ¸å‡†å¾Œæ›´æ–°ç´€éŒ„ã€‚</div>
    
    <div class="action-bar">
        <button class="btn-withdraw" onclick="toggleModal('withdrawModal', true)">ğŸ“‹ é ˜ç”¨ç™»è¨˜</button>
        <button class="btn-add" onclick="openAddModal()">ï¼‹ æ–°å¢åº«å­˜</button>
    </div>
    
    <table id="inventoryTable">
        <thead>
            <tr>
                <th width="12%">ç”¢å“é¡åˆ¥</th>
                <th width="10%">é¡è‰²</th>
                <th width="10%">é¡å‹</th>
                <th width="10%">ç”¢åœ°</th>
                <th width="10%">Phase</th>
                <th width="14%">åº«å­˜ (ç¸½æ•¸|å‰©é¤˜)</th>
                <th width="24%">å‚™è¨»</th>
                <th width="10%">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="inventoryBody"></tbody>
    </table>
</div>

<div id="itemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3 id="modalTitle">âœ¨ æ–°å¢åº«å­˜å“é …</h3></div>
        <input type="hidden" id="edit_index">
        
        <div class="field-group">
            <label>ç”¢å“é¡åˆ¥</label>
            <select id="i_cat" onchange="toggleOtherInput(this, 'i_cat_other')">
                <option value="è€³æ©Ÿ">è€³æ©Ÿ</option>
                <option value="ç·šæ">ç·šæ</option>
                <option value="Mic Boom">Mic Boom</option>
                <option value="å…¶ä»–">å…¶ä»–...</option>
            </select>
            <input type="text" id="i_cat_other" class="other-input" placeholder="è«‹è¼¸å…¥ç”¢å“é¡åˆ¥">
        </div>

        <div class="field-group">
            <label>é¡è‰²</label>
            <select id="i_color" onchange="toggleOtherInput(this, 'i_color_other')">
                <option value="Black">Black</option>
                <option value="White">White</option>
                <option value="N/A">N/A</option>
                <option value="å…¶ä»–">å…¶ä»–...</option>
            </select>
            <input type="text" id="i_color_other" class="other-input" placeholder="è«‹è¼¸å…¥é¡è‰²">
        </div>

        <div class="field-group">
            <label>é¡å‹</label>
            <select id="i_type" onchange="toggleOtherInput(this, 'i_type_other')">
                <option value="PC">PC</option>
                <option value="PS">PS</option>
                <option value="XBOX">XBOX</option>
                <option value="N/A">N/A</option>
                <option value="å…¶ä»–">å…¶ä»–...</option>
            </select>
            <input type="text" id="i_type_other" class="other-input" placeholder="è«‹è¼¸å…¥é¡å‹">
        </div>

        <div class="field-group">
            <label>ç”¢åœ°</label>
            <select id="i_origin" onchange="toggleOtherInput(this, 'i_origin_other')">
                <option value="China">China</option>
                <option value="Vietnam">Vietnam</option>
                <option value="Thailand">Thailand</option>
                <option value="å…¶ä»–">å…¶ä»–...</option>
            </select>
            <input type="text" id="i_origin_other" class="other-input" placeholder="è«‹è¼¸å…¥ç”¢åœ°">
        </div>

        <div class="field-group"><label>Phase</label><input type="text" id="i_phase" placeholder="ä¾‹å¦‚: MP, EVT..."></div>
        <div class="field-group"><label>ç¸½åº«å­˜æ•¸é‡</label><input type="number" id="i_qty" value="1" min="1"></div>
        <div class="field-group"><label>å‚™è¨» (åœ¨æ­¤ç·¨è¼¯)</label><textarea id="i_note" rows="4"></textarea></div>
        
        <button class="btn-save" onclick="saveItem()">å„²å­˜ä¸¦æ›´æ–°</button>
        <button style="background:none; color:gray; width:100%; margin-top:10px;" onclick="toggleModal('itemModal', false)">å–æ¶ˆ</button>
    </div>
</div>

<div id="withdrawModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>ğŸ“¦ é ˜ç”¨ç™»è¨˜</h3></div>
        <div class="field-group">
            <label>é¸æ“‡é ˜ç”¨å“é …</label>
            <select id="m_target" onchange="syncWithdrawDetails()"></select>
        </div>
        <div class="info-grid" id="m_detail_box" style="display:none;">
            <div class="info-item">ç”¢å“é¡åˆ¥: <b id="d_cat">-</b></div>
            <div class="info-item">ç”¢åœ°: <b id="d_origin">-</b></div>
            <div class="info-item">é¡è‰²: <b id="d_color">-</b></div>
            <div class="info-item">é¡å‹: <b id="d_type">-</b></div>
            <div class="info-item">Phase: <b id="d_phase">-</b></div>
            <div class="info-item" style="color: var(--secondary-color);">ç›®å‰å‰©é¤˜: <b id="d_remain">0</b></div>
        </div>
        <div class="field-group"><label>é ˜ç”¨æ•¸é‡</label><input type="number" id="m_qty" value="1" min="1"></div>
        <div class="field-group"><label>é ˜ç”¨åŸå›  / é ˜ç”¨äºº</label><textarea id="m_note" placeholder="è«‹è¼¸å…¥ç”¨é€”..."></textarea></div>
        <button class="btn-save" style="background:var(--secondary-color)" onclick="processWithdraw()">ç¢ºèªé ˜ç”¨</button>
        <button style="background:none; color:gray; width:100%; margin-top:10px;" onclick="toggleModal('withdrawModal', false)">å–æ¶ˆ</button>
    </div>
</div>

<script>
    const storageKey = 'Valkyrie_V14_Data';
    let stockData = JSON.parse(localStorage.getItem(storageKey)) || [];

    function saveData() { localStorage.setItem(storageKey, JSON.stringify(stockData)); }

    function toggleModal(id, show) {
        document.getElementById(id).style.display = show ? "block" : "none";
        if (id === 'withdrawModal' && show) renderWithdrawOptions();
    }

    // ä¿®æ­£ï¼šé¡¯éš±è¼¸å…¥æ¡†çš„é‚è¼¯
    function toggleOtherInput(selectObj, inputId) {
        const otherInput = document.getElementById(inputId);
        if (selectObj.value === "å…¶ä»–") {
            otherInput.style.display = "block";
        } else {
            otherInput.style.display = "none";
            otherInput.value = ""; // åˆ‡æ›å›é è¨­å€¼æ™‚æ¸…ç©ºæ‰‹æ‰“å…§å®¹
        }
    }

    function getVal(selectId, otherId) {
        const sel = document.getElementById(selectId);
        return sel.value === "å…¶ä»–" ? document.getElementById(otherId).value : sel.value;
    }

    // ä¿®æ­£ï¼šè¨­å€¼é‚è¼¯ï¼Œç¢ºä¿ç·¨è¼¯æ™‚èƒ½æ­£ç¢ºå›å¡«ä¸¦é¡¯ç¤ºè¼¸å…¥æ¡†
    function setVal(selectId, otherId, value) {
        const sel = document.getElementById(selectId);
        const otherInp = document.getElementById(otherId);
        
        // æª¢æŸ¥é è¨­ option ä¸­æ˜¯å¦æœ‰é€™å€‹å€¼
        let found = false;
        for(let i=0; i<sel.options.length; i++) {
            if(sel.options[i].value === value) {
                sel.value = value;
                found = true;
                break;
            }
        }

        if (found) {
            otherInp.style.display = 'none';
        } else {
            sel.value = "å…¶ä»–";
            otherInp.value = value;
            otherInp.style.display = 'block';
        }
    }

    function openAddModal() {
        document.getElementById('modalTitle').textContent = "âœ¨ æ–°å¢åº«å­˜å“é …";
        document.getElementById('edit_index').value = "-1";
        
        // é‡ç½®é¸å–®èˆ‡è¼¸å…¥æ¡†
        const fields = ["i_cat", "i_color", "i_type", "i_origin"];
        fields.forEach(id => {
            const sel = document.getElementById(id);
            sel.selectedIndex = 0;
            const other = document.getElementById(id + "_other");
            other.style.display = 'none';
            other.value = "";
        });

        document.getElementById('i_phase').value = "";
        document.getElementById('i_qty').value = 1;
        document.getElementById('i_note').value = "";
        toggleModal('itemModal', true);
    }

    function openEditModal(index) {
        const item = stockData[index];
        document.getElementById('modalTitle').textContent = "âœï¸ ç·¨è¼¯åº«å­˜å“é …";
        document.getElementById('edit_index').value = index;
        
        setVal('i_cat', 'i_cat_other', item.category);
        setVal('i_color', 'i_color_other', item.color);
        setVal('i_type', 'i_type_other', item.type);
        setVal('i_origin', 'i_origin_other', item.origin);
        
        document.getElementById('i_phase').value = item.phase;
        document.getElementById('i_qty').value = item.qty;
        document.getElementById('i_note').value = item.note;
        toggleModal('itemModal', true);
    }

    function saveItem() {
        const idx = document.getElementById('edit_index').value;
        const qty = parseInt(document.getElementById('i_qty').value);
        
        const data = { 
            category: getVal('i_cat', 'i_cat_other'),
            color: getVal('i_color', 'i_color_other'),
            type: getVal('i_type', 'i_type_other'),
            origin: getVal('i_origin', 'i_origin_other'),
            phase: document.getElementById('i_phase').value || "N/A",
            qty: qty, 
            remain: (idx === "-1" ? qty : Math.max(0, stockData[idx].remain + (qty - stockData[idx].qty))),
            note: document.getElementById('i_note').value 
        };

        if(!data.category || !data.origin) { alert("è«‹å¡«å¯«é¡åˆ¥èˆ‡ç”¢åœ°ï¼"); return; }
        
        if(idx === "-1") stockData.push(data); else stockData[idx] = data;
        saveData(); renderTable(); toggleModal('itemModal', false);
    }

    function renderWithdrawOptions() {
        const select = document.getElementById("m_target");
        select.innerHTML = '<option value="">-- è«‹é¸æ“‡é ˜ç”¨å“é … --</option>';
        stockData.forEach((item, index) => {
            let opt = document.createElement("option");
            opt.value = index;
            opt.textContent = `[${item.category}] ${item.color}-${item.type} (${item.origin}) - ${item.phase}`;
            select.appendChild(opt);
        });
        syncWithdrawDetails();
    }

    function syncWithdrawDetails() {
        const idx = document.getElementById("m_target").value;
        const box = document.getElementById("m_detail_box");
        if (idx !== "") {
            const item = stockData[idx];
            document.getElementById("d_cat").textContent = item.category;
            document.getElementById("d_origin").textContent = item.origin;
            document.getElementById("d_color").textContent = item.color;
            document.getElementById("d_type").textContent = item.type;
            document.getElementById("d_phase").textContent = item.phase;
            document.getElementById("d_remain").textContent = item.remain;
            box.style.display = "grid";
        } else { box.style.display = "none"; }
    }

    function processWithdraw() {
        const idx = document.getElementById("m_target").value;
        const q = parseInt(document.getElementById("m_qty").value);
        if(idx === "" || q > stockData[idx].remain) { alert("åº«å­˜ä¸è¶³ï¼"); return; }
        stockData[idx].remain -= q;
        const timestamp = new Date().toLocaleString('zh-TW', {hour12:false});
        stockData[idx].note += `\n>> ${timestamp} | é ˜ç”¨ -${q} | åŸå› : ${document.getElementById("m_note").value}`;
        saveData(); renderTable(); toggleModal('withdrawModal', false);
    }

    function renderTable() {
        const tbody = document.getElementById("inventoryBody");
        tbody.innerHTML = "";
        stockData.forEach((item, index) => {
            let row = document.createElement("tr");
            row.innerHTML = `
                <td>${item.category}</td>
                <td>${item.color}</td>
                <td>${item.type}</td>
                <td>${item.origin}</td>
                <td>${item.phase}</td>
                <td><div class="qty-box"><span style="color:#95a5a6">${item.qty}</span> | <b>${item.remain}</b></div></td>
                <td><div class="readonly-note">${item.note || '(ç„¡ç´€éŒ„)'}</div></td>
                <td class="ops-cell">
                    <button class="btn-edit" onclick="openEditModal(${index})">ç·¨è¼¯</button>
                    <button class="btn-delete" onclick="deleteRow(${index})">åˆªé™¤</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function deleteRow(index) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤å“é …åŠå…¶æ‰€æœ‰ç´€éŒ„ï¼Ÿ")) { stockData.splice(index, 1); saveData(); renderTable(); } }
    renderTable();
</script>
</body>
</html>
