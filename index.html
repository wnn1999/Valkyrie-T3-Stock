<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Valkyrie T3 Stock ç®¡ç†ç³»çµ±</title>
    <style>
        :root { --primary-color: #2ecc71; --secondary-color: #d35400; --dark-blue: #34495e; --edit-color: #9b59b6; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 1250px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .header { text-align: center; margin-bottom: 20px; }
        .header img { max-width: 120px; margin-bottom: 10px; }
        h2 { font-family: "Cooper Black", serif; color: var(--primary-color); font-size: 3em; margin: 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .alert-info { background-color: #e8f8f0; border-left: 5px solid var(--primary-color); padding: 15px; margin: 20px 0; border-radius: 4px; font-size: 0.95em; }
        .action-bar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px; }
        button { cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.3s; display: flex; align-items: center; gap: 8px; padding: 10px 18px; }
        .btn-withdraw { background-color: var(--secondary-color); color: white; }
        .btn-add { background-color: #3498db; color: white; }
        .btn-edit { background-color: var(--edit-color); color: white; font-size: 12px; padding: 5px 10px; }
        .btn-delete { background-color: #bdc3c7; color: white; font-size: 12px; padding: 5px 10px; }
        .btn-save { background-color: var(--primary-color); color: white; width: 100%; justify-content: center; margin-top: 15px; font-size: 1.1em; }
        table { width: 100%; border-collapse: collapse; background: white; table-layout: fixed; }
        th { background-color: var(--dark-blue); color: white; padding: 15px; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; word-wrap: break-word; }
        .readonly-note { background-color: #f9f9f9; border: 1px solid #eee; color: #7f8c8d; font-size: 12px; text-align: left; padding: 5px; border-radius: 4px; white-space: pre-wrap; max-height: 80px; overflow-y: auto; }
        .qty-box { font-size: 1.1em; font-weight: bold; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { background: white; margin: 5% auto; padding: 25px; border-radius: 12px; width: 450px; max-height: 85vh; overflow-y: auto; }
        .field { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .other-input { display: none; margin-top: 8px; border: 1px solid var(--primary-color); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="snake.png" alt="Logo">
        <h2>Valkyrie T3 Stock</h2>
    </div>
    <div class="alert-info">ğŸ“¢ ç³»çµ±å·²é€£æ¥è‡³ Supabase å³æ™‚è³‡æ–™åº«ã€‚</div>
    <div class="action-bar">
        <button class="btn-withdraw" onclick="toggleModal('withdrawModal', true)">ğŸ“‹ é ˜ç”¨ç™»è¨˜</button>
        <button class="btn-add" onclick="openAddModal()">ï¼‹ æ–°å¢åº«å­˜</button>
    </div>
    <table>
        <thead>
            <tr>
                <th width="12%">é¡åˆ¥</th><th width="10%">é¡è‰²</th><th width="10%">é¡å‹</th><th width="10%">ç”¢åœ°</th><th width="10%">Phase</th><th width="14%">åº«å­˜ (ç¸½|å‰©)</th><th width="24%">å‚™è¨»</th><th width="10%">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="inventoryBody"></tbody>
    </table>
</div>

<div id="itemModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">âœ¨ æ–°å¢åº«å­˜</h3>
        <input type="hidden" id="edit_index">
        <div class="field">
            <label>ç”¢å“é¡åˆ¥</label>
            <select id="i_cat" onchange="toggleOther(this, 'i_cat_other')">
                <option value="è€³æ©Ÿ">è€³æ©Ÿ</option><option value="ç·šæ">ç·šæ</option><option value="Mic Boom">Mic Boom</option><option value="å…¶ä»–">å…¶ä»–...</option>
            </select>
            <input type="text" id="i_cat_other" class="other-input">
        </div>
        <div class="field">
            <label>é¡è‰²</label>
            <select id="i_color" onchange="toggleOther(this, 'i_color_other')">
                <option value="Black">Black</option><option value="White">White</option><option value="N/A">N/A</option><option value="å…¶ä»–">å…¶ä»–...</option>
            </select>
            <input type="text" id="i_color_other" class="other-input">
        </div>
        <div class="field">
            <label>ç”¢åœ°</label>
            <select id="i_origin" onchange="toggleOther(this, 'i_origin_other')">
                <option value="China">China</option><option value="Vietnam">Vietnam</option><option value="Thailand">Thailand</option><option value="å…¶ä»–">å…¶ä»–...</option>
            </select>
            <input type="text" id="i_origin_other" class="other-input">
        </div>
        <div class="field"><label>Phase</label><input type="text" id="i_phase"></div>
        <div class="field"><label>ç¸½åº«å­˜æ•¸é‡</label><input type="number" id="i_qty" value="1"></div>
        <div class="field"><label>å‚™è¨»</label><textarea id="i_note"></textarea></div>
        <button class="btn-save" onclick="saveToSupabase()">å„²å­˜è³‡æ–™</button>
        <button style="background:none; width:100%; margin-top:10px; color:gray" onclick="toggleModal('itemModal', false)">å–æ¶ˆ</button>
    </div>
</div>

<div id="withdrawModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ“¦ é ˜ç”¨ç™»è¨˜</h3>
        <div class="field"><label>å“é …</label><select id="m_target"></select></div>
        <div class="field"><label>é ˜ç”¨æ•¸é‡</label><input type="number" id="m_qty" value="1"></div>
        <div class="field"><label>åŸå› /äººå“¡</label><textarea id="m_note"></textarea></div>
        <button class="btn-save" style="background:var(--secondary-color)" onclick="withdrawStock()">ç¢ºèªé ˜ç”¨</button>
        <button style="background:none; width:100%; margin-top:10px; color:gray" onclick="toggleModal('withdrawModal', false)">å–æ¶ˆ</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const db = supabase.createClient('https://djjczmcajxjyqjkbjoud.supabase.co', 'sb_publishable_kHc06K5jzjqPiAVj-eMGTg_1oOhA_6t');
    let stockData = [];

    // æŠ“å–èˆ‡ç›£è½ (è«‹æ³¨æ„è¡¨åç‚º message)
    async function loadData() {
        const { data, error } = await db.from('message').select('*').order('created_at', { ascending: true });
        if (error) return console.error(error);
        stockData = data.map(d => ({ db_id: d.id, ...JSON.parse(d.content) }));
        render();
    }

    db.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'message' }, loadData).subscribe();

    async function saveToSupabase() {
        const idx = document.getElementById('edit_index').value;
        const qty = parseInt(document.getElementById('i_qty').value);
        const payload = {
            category: getV('i_cat', 'i_cat_other'),
            color: getV('i_color', 'i_color_other'),
            origin: getV('i_origin', 'i_origin_other'),
            type: "N/A", // ç°¡åŒ–æ¬„ä½
            phase: document.getElementById('i_phase').value || "N/A",
            qty: qty,
            remain: (idx === "-1" ? qty : Math.max(0, stockData[idx].remain + (qty - stockData[idx].qty))),
            note: document.getElementById('i_note').value
        };

        if (idx === "-1") {
            await db.from('message').insert([{ content: JSON.stringify(payload) }]);
        } else {
            await db.from('message').update({ content: JSON.stringify(payload) }).eq('id', stockData[idx].db_id);
        }
        toggleModal('itemModal', false);
    }

    async function withdrawStock() {
        const idx = document.getElementById("m_target").value;
        const q = parseInt(document.getElementById("m_qty").value);
        if(!idx || q > stockData[idx].remain) return alert("æ•¸é‡éŒ¯èª¤ï¼");

        const item = {...stockData[idx]};
        const tid = item.db_id;
        item.remain -= q;
        item.note += `\n>> ${new Date().toLocaleString()} | é ˜ç”¨ -${q} | ${document.getElementById("m_note").value}`;
        
        delete item.db_id;
        await db.from('message').update({ content: JSON.stringify(item) }).eq('id', tid);
        toggleModal('withdrawModal', false);
    }

    async function deleteItem(idx) {
        if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await db.from('message').delete().eq('id', stockData[idx].db_id);
    }

    // UI Helper
    function render() {
        const b = document.getElementById("inventoryBody"); b.innerHTML = "";
        stockData.forEach((item, i) => {
            b.innerHTML += `<tr>
                <td>${item.category}</td><td>${item.color}</td><td>${item.type}</td><td>${item.origin}</td><td>${item.phase}</td>
                <td><div class="qty-box">${item.qty} | <b style="color:var(--secondary-color)">${item.remain}</b></div></td>
                <td><div class="readonly-note">${item.note}</div></td>
                <td><button class="btn-edit" onclick="openEdit(${i})">æ”¹</button><button class="btn-delete" onclick="deleteItem(${i})">åˆª</button></td>
            </tr>`;
        });
    }

    function toggleModal(id, s) { 
        document.getElementById(id).style.display = s ? "block" : "none"; 
        if(id==='withdrawModal' && s) {
            const sel = document.getElementById("m_target");
            sel.innerHTML = stockData.map((it, i) => `<option value="${i}">${it.category}-${it.phase}</option>`).join('');
        }
    }
    function toggleOther(s, i) { document.getElementById(i).style.display = s.value === "å…¶ä»–" ? "block" : "none"; }
    function getV(s, i) { const el = document.getElementById(s); return el.value === "å…¶ä»–" ? document.getElementById(i).value : el.value; }
    function openAddModal() { document.getElementById('edit_index').value = "-1"; toggleModal('itemModal', true); }
    function openEdit(i) {
        const it = stockData[i]; document.getElementById('edit_index').value = i;
        document.getElementById('i_phase').value = it.phase;
        document.getElementById('i_qty').value = it.qty;
        document.getElementById('i_note').value = it.note;
        toggleModal('itemModal', true);
    }

    loadData();
</script>
</body>
</html>
