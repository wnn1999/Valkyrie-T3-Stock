<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // 2. 初始化 Supabase 連線
    const SUPABASE_URL = 'https://djjczmcajxjyqjkbjoud.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_kHc06K5jzjqPiAVj-eMGTg_1oOhA_6t';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let stockData = [];

    // --- 核心功能：從 Supabase 抓取資料 ---
    async function fetchStockData() {
        // 從名為 'message' 的表格讀取 (依據你的描述，如果是 messages 請自行修正)
        const { data, error } = await supabase
            .from('message') 
            .select('*')
            .order('created_at', { ascending: true });
        
        if (error) {
            console.error('抓取資料失敗:', error.message);
        } else {
            // 將資料庫中的 content (JSON 字串) 解析回物件並記錄 db_id
            stockData = data.map(item => ({
                db_id: item.id,
                ...JSON.parse(item.content)
            }));
            renderTable();
        }
    }

    // --- 核心需求：Supabase Realtime 即時監聽 ---
    // 監聽資料庫的任何變動 (新增、更新、刪除)，並即時刷新列表
    supabase
        .channel('schema-db-changes')
        .on('postgres_changes', { 
            event: '*', 
            schema: 'public', 
            table: 'message' 
        }, (payload) => {
            console.log('偵測到雲端更新，同步中...', payload);
            fetchStockData();
        })
        .subscribe();

    // 3. 儲存/更新資料到 Supabase (insert & update)
    async function saveItem() {
        const idx = document.getElementById('edit_index').value;
        const qty = parseInt(document.getElementById('i_qty').value);
        
        const payload = { 
            category: getVal('i_cat', 'i_cat_other'),
            color: getVal('i_color', 'i_color_other'),
            type: getVal('i_type', 'i_type_other'),
            origin: getVal('i_origin', 'i_origin_other'),
            phase: document.getElementById('i_phase').value || "N/A",
            qty: qty, 
            remain: (idx === "-1" ? qty : Math.max(0, stockData[idx].remain + (qty - stockData[idx].qty))),
            note: document.getElementById('i_note').value 
        };

        if(!payload.category || !payload.origin) { alert("請填寫必要欄位！"); return; }

        if (idx === "-1") {
            // 新增資料到雲端
            const { error } = await supabase.from('message').insert([{ content: JSON.stringify(payload) }]);
            if (error) alert("儲存失敗: " + error.message);
        } else {
            // 更新雲端既有資料
            const targetId = stockData[idx].db_id;
            const { error } = await supabase.from('message').update({ content: JSON.stringify(payload) }).eq('id', targetId);
            if (error) alert("更新失敗: " + error.message);
        }

        toggleModal('itemModal', false);
    }

    // 4. 領用登記連動雲端
    async function processWithdraw() {
        const idx = document.getElementById("m_target").value;
        const q = parseInt(document.getElementById("m_qty").value);
        if(idx === "" || q > stockData[idx].remain) { alert("庫存不足或未選擇品項！"); return; }

        const item = {...stockData[idx]}; // 複製物件
        const targetId = item.db_id;
        
        item.remain -= q;
        const timestamp = new Date().toLocaleString('zh-TW', {hour12:false});
        item.note += `\n>> ${timestamp} | 領用 -${q} | 原因: ${document.getElementById("m_note").value}`;

        // 移除輔助用的 db_id 後存回
        delete item.db_id;
        const { error } = await supabase.from('message').update({ content: JSON.stringify(item) }).eq('id', targetId);
        
        if (error) {
            alert("領用失敗: " + error.message);
        } else {
            toggleModal('withdrawModal', false);
        }
    }

    // 5. 刪除雲端資料
    async function deleteRow(index) {
        if(confirm("確定刪除此品項？這將永久移除雲端紀錄。")) {
            const targetId = stockData[index].db_id;
            const { error } = await supabase.from('message').delete().eq('id', targetId);
            if (error) alert("刪除失敗: " + error.message);
        }
    }

    // --- 以下為 UI 控制邏輯 (與原本系統保持一致) ---

    function toggleModal(id, show) {
        document.getElementById(id).style.display = show ? "block" : "none";
        if (id === 'withdrawModal' && show) renderWithdrawOptions();
    }

    function toggleOtherInput(selectObj, inputId) {
        document.getElementById(inputId).style.display = (selectObj.value === "其他") ? "block" : "none";
    }

    function getVal(selectId, otherId) {
        const sel = document.getElementById(selectId);
        return sel.value === "其他" ? document.getElementById(otherId).value : sel.value;
    }

    function setVal(selectId, otherId, value, defaultList) {
        const sel = document.getElementById(selectId);
        const otherInp = document.getElementById(otherId);
        if (defaultList.includes(value)) {
            sel.value = value;
            otherInp.style.display = 'none';
        } else {
            sel.value = "其他";
            otherInp.value = value;
            otherInp.style.display = 'block';
        }
    }

    function openAddModal() {
        document.getElementById('modalTitle').textContent = "✨ 新增庫存品項";
        document.getElementById('edit_index').value = "-1";
        ["i_cat", "i_color", "i_type", "i_origin"].forEach(id => {
            document.getElementById(id).selectedIndex = 0;
            document.getElementById(id + "_other").style.display = 'none';
            document.getElementById(id + "_other").value = "";
        });
        document.getElementById('i_phase').value = "";
        document.getElementById('i_qty').value = 1;
        document.getElementById('i_note').value = "";
        toggleModal('itemModal', true);
    }

    function openEditModal(index) {
        const item = stockData[index];
        document.getElementById('modalTitle').textContent = "✏️ 編輯庫存品項";
        document.getElementById('edit_index').value = index;
        setVal('i_cat', 'i_cat_other', item.category, ["耳機", "線材", "Mic Boom"]);
        setVal('i_color', 'i_color_other', item.color, ["Black", "White", "N/A"]);
        setVal('i_type', 'i_type_other', item.type, ["PC", "PS", "XBOX", "N/A"]);
        setVal('i_origin', 'i_origin_other', item.origin, ["China", "Vietnam", "Thailand"]);
        document.getElementById('i_phase').value = item.phase;
        document.getElementById('i_qty').value = item.qty;
        document.getElementById('i_note').value = item.note;
        toggleModal('itemModal', true);
    }

    function renderWithdrawOptions() {
        const select = document.getElementById("m_target");
        select.innerHTML = '<option value="">-- 請選擇領用品項 --</option>';
        stockData.forEach((item, index) => {
            let opt = document.createElement("option");
            opt.value = index;
            opt.textContent = `[${item.category}] ${item.color}-${item.type} (${item.origin}) - ${item.phase}`;
            select.appendChild(opt);
        });
        syncWithdrawDetails();
    }

    function syncWithdrawDetails() {
        const idx = document.getElementById("m_target").value;
        const box = document.getElementById("m_detail_box");
        if (idx !== "" && stockData[idx]) {
            const item = stockData[idx];
            document.getElementById("d_cat").textContent = item.category;
            document.getElementById("d_origin").textContent = item.origin;
            document.getElementById("d_color").textContent = item.color;
            document.getElementById("d_type").textContent = item.type;
            document.getElementById("d_phase").textContent = item.phase;
            document.getElementById("d_remain").textContent = item.remain;
            box.style.display = "grid";
        } else { box.style.display = "none"; }
    }

    function renderTable() {
        const tbody = document.getElementById("inventoryBody");
        tbody.innerHTML = "";
        stockData.forEach((item, index) => {
            let row = document.createElement("tr");
            row.innerHTML = `
                <td>${item.category}</td>
                <td>${item.color}</td>
                <td>${item.type}</td>
                <td>${item.origin}</td>
                <td>${item.phase}</td>
                <td><div class="qty-box"><span style="color:#95a5a6">${item.qty}</span> | <b>${item.remain}</b></div></td>
                <td><div class="readonly-note">${item.note || '(無紀錄)'}</div></td>
                <td class="ops-cell">
                    <button class="btn-edit" onclick="openEditModal(${index})">編輯</button>
                    <button class="btn-delete" onclick="deleteRow(${index})">刪除</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // 啟動抓取初始資料
    fetchStockData();
</script>
